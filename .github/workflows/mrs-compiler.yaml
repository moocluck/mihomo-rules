name: Generate MRS files for Mihomo

on:
  push:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate_mrs:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    steps:
      - name: üîç Checkout repo
        uses: actions/checkout@v4
        
      - name: üì• Pull Changes
        run: git pull

      - name: üíΩ Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y curl wget git jq
         
      - name: üîç Get Latest Mihomo Version
        id: get_version
        run: |
          LATEST_RELEASE=$(curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest)
          VERSION=$(echo "$LATEST_RELEASE" | jq -r '.tag_name')
          {
            echo "MIHOMO_VERSION=$VERSION"
            echo "MIHOMO_DOWNLOAD_URL<<EOF"
            echo "$(echo "$LATEST_RELEASE" | jq -r '.assets[] | select(.name | contains("mihomo-linux-amd64-") and endswith(".deb")) | .browser_download_url')"
            echo "EOF"
          } >> $GITHUB_ENV

      - name: üì• Download and install Mihomo
        run: |
          curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -L "${{ env.MIHOMO_DOWNLOAD_URL }}" -o mihomo-linux-amd64.deb
          sudo apt install --fix-missing ./mihomo-linux-amd64.deb
        
      - name: ‚öôÔ∏è Generate MRS files
        run: |
          mkdir -p rule-sets
          # –û–±—Ä–∞–±–æ—Ç–∫–∞ domain-list
          for file in domain-list/*.yaml; do
            [ -f "$file" ] || continue
            base=$(basename "$file" .yaml)
            mihomo convert-ruleset domain yaml "$file" "rule-sets/$base.mrs"
          done
          # –û–±—Ä–∞–±–æ—Ç–∫–∞ ip-list
          for file in ip-list/*.yaml; do
            [ -f "$file" ] || continue
            base=$(basename "$file" .yaml)
            mihomo convert-ruleset ipcidr yaml "$file" "rule-sets/$base.mrs"
          done

      - name: üóëÔ∏è Delete temp file
        run: |
          rm mihomo-linux-amd64.deb
          
      - name: üìÖ Get current date
        id: date
        run: |
          echo "DATE=$(TZ=Europe/Moscow date +'%Y-%m-%dT%H:%M:%S')" >> $GITHUB_ENV
      
      - name: üì§ Commit and Push Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          git commit -m "Generating .mrs rule-sets ${{ env.DATE }}" -a || echo "No changes to commit"
          git push